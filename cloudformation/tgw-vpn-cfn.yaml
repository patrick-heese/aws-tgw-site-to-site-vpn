AWSTemplateFormatVersion: '2010-09-09'
Description: >
  TGW Site-to-Site VPN with optional simulated on-prem (pfSense router + server)
  and an AWS-side private test instance. Uses default TGW route table association/propagation.

Parameters:
  ProjectName:
    Type: String
    Default: s2s-tgw-sim

  SimulateOnPrem:
    Type: String
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'

  AdminCidr:
    Type: String
    Default: 0.0.0.0/0
    Description: CIDR allowed to access the pfSense UI/SSH (use your /32 for security).

  KeyPairName:
    Type: String
    Default: NONE
    Description: Optional EC2 key pair name for SSH (pfSense or on-prem server). Use NONE to disable SSH key injection.

  # AWS side
  VpcCidr:
    Type: String
    Default: 10.0.0.0/16

  TgwSubnet1Cidr:
    Type: String
    Default: 10.0.0.0/24

  TgwSubnet2Cidr:
    Type: String
    Default: 10.0.1.0/24

  AmazonSideAsn:
    Type: Number
    Default: 64512

  VpnEcmpSupport:
    Type: String
    Default: enable
    AllowedValues:
      - enable
      - disable

  # On-prem identifiers (used even if simulated)
  CgwAsn:
    Type: Number
    Default: 65010

  OnPremCidr:
    Type: String
    Default: 192.168.0.0/16

  # If NOT simulating on-prem, you can pass a real public IP here
  CgwIpAddress:
    Type: String
    Default: ''
    Description: Public IP of your real on-prem device (ignored when SimulateOnPrem=true).

  # VPN options
  EnableAcceleration:
    Type: String
    Default: 'false'
    AllowedValues:
      - 'true'
      - 'false'

  TunnelInsideIpVersion:
    Type: String
    Default: ipv4
    AllowedValues:
      - ipv4

  IKEVersion:
    Type: String
    Default: ikev2
    AllowedValues:
      - ikev1
      - ikev2

  Tunnel1InsideCidr:
    Type: String
    Default: 169.254.110.0/30

  Tunnel2InsideCidr:
    Type: String
    Default: 169.254.111.0/30

  ProvidePsks:
    Type: String
    Default: 'false'
    AllowedValues:
      - 'true'
      - 'false'
    Description: If 'true', include PreSharedKey values from parameters below. Otherwise AWS generates PSKs.

  Tunnel1Psk:
    Type: String
    NoEcho: true
    Default: ''

  Tunnel2Psk:
    Type: String
    NoEcho: true
    Default: ''

  TunnelLogGroupName:
    Type: String
    Default: /aws/vpn/tunnels

  TunnelLogRetentionDays:
    Type: Number
    Default: 14

  AL2023AmiParam:
    Type: 'AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>'
    Default: /aws/service/ami-amazon-linux-latest/al2023-ami-kernel-6.1-x86_64
    Description: SSM alias for Amazon Linux 2023 AMI ID

  OnPremAmiId:
    Type: AWS::EC2::Image::Id
    Description: Netgate pfSense AMI ID for this Region (subscribe in AWS Marketplace, then paste AMI ID)

Conditions:
  DoSimOnPrem: !Equals
    - !Ref SimulateOnPrem
    - 'true'
  AccelEnabled: !Equals
    - !Ref EnableAcceleration
    - 'true'
  UseProvidedPSK: !Equals
    - !Ref ProvidePsks
    - 'true'
  HasKeyPair: !Not
    - !Equals
      - !Ref KeyPairName
      - 'NONE'

Resources:
  # ------------------------
  # AWS side (TGW + VPC + test instance)
  # ------------------------
  Vpc:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-vpc'

  SubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone: !Select
        - 0
        - !GetAZs ''
      VpcId: !Ref Vpc
      CidrBlock: !Ref TgwSubnet1Cidr
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-subnet-a'

  SubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone: !Select
        - 1
        - !GetAZs ''
      VpcId: !Ref Vpc
      CidrBlock: !Ref TgwSubnet2Cidr
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-subnet-b'

  RtPrivate:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref Vpc
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-rt-private'

  RtAssocA:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref RtPrivate
      SubnetId: !Ref SubnetA

  RtAssocB:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref RtPrivate
      SubnetId: !Ref SubnetB

  TGW:
    Type: AWS::EC2::TransitGateway
    Properties:
      AmazonSideAsn: !Ref AmazonSideAsn
      DnsSupport: enable
      VpnEcmpSupport: !Ref VpnEcmpSupport
      DefaultRouteTableAssociation: enable
      DefaultRouteTablePropagation: enable
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-tgw'

  VpcAttach:
    Type: AWS::EC2::TransitGatewayAttachment
    Properties:
      TransitGatewayId: !Ref TGW
      VpcId: !Ref Vpc
      SubnetIds:
        - !Ref SubnetA
        - !Ref SubnetB
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-tgw-vpc-attach'

  AwsTestSg:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow ICMP from on-prem for testing
      VpcId: !Ref Vpc
      SecurityGroupIngress:
        - IpProtocol: icmp
          FromPort: -1
          ToPort: -1
          CidrIp: !Ref OnPremCidr
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-aws-test-sg'

  AwsTestInstance:
    Type: AWS::EC2::Instance
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      InstanceType: t3.micro
      ImageId: !Ref AL2023AmiParam
      NetworkInterfaces:
        - AssociatePublicIpAddress: false
          DeviceIndex: 0
          GroupSet:
            - !Ref AwsTestSg
          SubnetId: !Ref SubnetA
      MetadataOptions:
        HttpTokens: required
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-aws-test'

  # ------------------------
  # On-prem simulation (optional, pfSense router + private server)
  # ------------------------
  OnPremVpc:
    Type: AWS::EC2::VPC
    Condition: DoSimOnPrem
    Properties:
      CidrBlock: !Ref OnPremCidr
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-onprem'

  OnPremIgw:
    Type: AWS::EC2::InternetGateway
    Condition: DoSimOnPrem

  OnPremIgwAttach:
    Type: AWS::EC2::VPCGatewayAttachment
    Condition: DoSimOnPrem
    Properties:
      InternetGatewayId: !Ref OnPremIgw
      VpcId: !Ref OnPremVpc

  OnPremSubnetPub:
    Type: AWS::EC2::Subnet
    Condition: DoSimOnPrem
    Properties:
      AvailabilityZone: !Select
        - 0
        - !GetAZs ''
      VpcId: !Ref OnPremVpc
      CidrBlock: 192.168.0.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-onprem-public'

  OnPremSubnetPriv:
    Type: AWS::EC2::Subnet
    Condition: DoSimOnPrem
    Properties:
      AvailabilityZone: !Select
        - 0
        - !GetAZs ''
      VpcId: !Ref OnPremVpc
      CidrBlock: 192.168.1.0/24
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-onprem-private'

  OnPremRtPub:
    Type: AWS::EC2::RouteTable
    Condition: DoSimOnPrem
    Properties:
      VpcId: !Ref OnPremVpc
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-onprem-rt-public'

  OnPremRtPriv:
    Type: AWS::EC2::RouteTable
    Condition: DoSimOnPrem
    Properties:
      VpcId: !Ref OnPremVpc
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-onprem-rt-private'

  OnPremRtAssocPub:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: DoSimOnPrem
    Properties:
      RouteTableId: !Ref OnPremRtPub
      SubnetId: !Ref OnPremSubnetPub

  OnPremRtAssocPriv:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: DoSimOnPrem
    Properties:
      RouteTableId: !Ref OnPremRtPriv
      SubnetId: !Ref OnPremSubnetPriv

  OnPremRtDefault:
    Type: AWS::EC2::Route
    Condition: DoSimOnPrem
    Properties:
      RouteTableId: !Ref OnPremRtPub
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref OnPremIgw

  OnPremRouterSg:
    Type: AWS::EC2::SecurityGroup
    Condition: DoSimOnPrem
    Properties:
      GroupDescription: Allow pfSense HTTPS UI + IKE/NAT-T (and optional SSH)
      VpcId: !Ref OnPremVpc
      SecurityGroupIngress:
        - IpProtocol: tcp   # pfSense Web UI
          FromPort: 443
          ToPort: 443
          CidrIp: !Ref AdminCidr
        - IpProtocol: tcp   # optional SSH
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref AdminCidr
        - IpProtocol: udp   # IKE
          FromPort: 500
          ToPort: 500
          CidrIp: 0.0.0.0/0
        - IpProtocol: udp   # NAT-T
          FromPort: 4500
          ToPort: 4500
          CidrIp: 0.0.0.0/0
        # Optional: if not using NAT-T, allow ESP (protocol 50)
        # - IpProtocol: 50
        #   CidrIp: 0.0.0.0/0
        - IpProtocol: icmp
          FromPort: -1
          ToPort: -1
          CidrIp: 192.168.1.0/24
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-onprem-router-sg'

  OnPremServerSg:
    Type: AWS::EC2::SecurityGroup
    Condition: DoSimOnPrem
    Properties:
      GroupDescription: Allow ICMP from VPC for testing
      VpcId: !Ref OnPremVpc
      SecurityGroupIngress:
        - IpProtocol: icmp
          FromPort: -1
          ToPort: -1
          CidrIp: !Ref VpcCidr
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 192.168.0.0/24
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref AdminCidr 
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-onprem-server-sg'

  OnPremRouterEip:
    Type: AWS::EC2::EIP
    Condition: DoSimOnPrem
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-onprem-eip'

  VpnTunnelLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      LogGroupName: !Sub '${TunnelLogGroupName}-${AWS::StackName}'
      RetentionInDays: !Ref TunnelLogRetentionDays

  OnPremRouter:
    Type: AWS::EC2::Instance
    Condition: DoSimOnPrem
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      InstanceType: t3.micro
      KeyName: !If
        - HasKeyPair
        - !Ref KeyPairName
        - !Ref 'AWS::NoValue'
      ImageId: !Ref OnPremAmiId
      NetworkInterfaces:
        - AssociatePublicIpAddress: false
          DeviceIndex: 0
          GroupSet:
            - !Ref OnPremRouterSg
          SubnetId: !Ref OnPremSubnetPub
      SourceDestCheck: false
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-onprem-router'
      # No UserData; pfSense configured via its web UI

  OnPremEipAssoc:
    Type: AWS::EC2::EIPAssociation
    Condition: DoSimOnPrem
    Properties:
      AllocationId: !GetAtt OnPremRouterEip.AllocationId
      InstanceId: !Ref OnPremRouter

  OnPremServer:
    Type: AWS::EC2::Instance
    Condition: DoSimOnPrem
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      InstanceType: t3.micro
      KeyName: !If
        - HasKeyPair
        - !Ref KeyPairName
        - !Ref 'AWS::NoValue'
      ImageId: !Ref AL2023AmiParam
      NetworkInterfaces:
        - AssociatePublicIpAddress: false
          DeviceIndex: 0
          GroupSet:
            - !Ref OnPremServerSg
          SubnetId: !Ref OnPremSubnetPriv
      MetadataOptions:
        HttpTokens: required
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-onprem-server'

  OnPremRtPrivDefault:
    Type: AWS::EC2::Route
    Condition: DoSimOnPrem
    Properties:
      RouteTableId: !Ref OnPremRtPriv
      DestinationCidrBlock: 0.0.0.0/0
      InstanceId: !Ref OnPremRouter

  # ------------------------
  # Customer Gateway + VPN (uses EIP if simulated)
  # ------------------------
  CustomerGateway:
    Type: AWS::EC2::CustomerGateway
    Properties:
      BgpAsn: !Ref CgwAsn
      IpAddress: !If
        - DoSimOnPrem
        - !GetAtt OnPremRouterEip.PublicIp
        - !Ref CgwIpAddress
      Type: ipsec.1
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-cgw'

  VpnConnection:
    Type: AWS::EC2::VPNConnection
    Properties:
      Type: ipsec.1
      TransitGatewayId: !Ref TGW
      CustomerGatewayId: !Ref CustomerGateway
      EnableAcceleration: !If
        - AccelEnabled
        - true
        - false
      TunnelInsideIpVersion: !Ref TunnelInsideIpVersion
      VpnTunnelOptionsSpecifications:
        - IKEVersions:
            - Value: !Ref IKEVersion
          TunnelInsideCidr: !Ref Tunnel1InsideCidr
          LogOptions:
            CloudwatchLogOptions:
              LogEnabled: true
              LogGroupArn: !GetAtt VpnTunnelLogGroup.Arn
              LogOutputFormat: json
          Phase1EncryptionAlgorithms:
            - Value: AES256
            - Value: AES256-GCM-16
          Phase2EncryptionAlgorithms:
            - Value: AES256
            - Value: AES256-GCM-16
          Phase1IntegrityAlgorithms:
            - Value: SHA2-256
            - Value: SHA2-384
          Phase2IntegrityAlgorithms:
            - Value: SHA2-256
            - Value: SHA2-384
          Phase1DHGroupNumbers:
            - Value: 14
            - Value: 16
          Phase2DHGroupNumbers:
            - Value: 14
            - Value: 16
          StartupAction: start
          PreSharedKey: !If
            - UseProvidedPSK
            - !Ref Tunnel1Psk
            - !Ref 'AWS::NoValue'
        - IKEVersions:
            - Value: !Ref IKEVersion
          TunnelInsideCidr: !Ref Tunnel2InsideCidr
          LogOptions:
            CloudwatchLogOptions:
              LogEnabled: true
              LogGroupArn: !GetAtt VpnTunnelLogGroup.Arn
              LogOutputFormat: json
          Phase1EncryptionAlgorithms:
            - Value: AES256
            - Value: AES256-GCM-16
          Phase2EncryptionAlgorithms:
            - Value: AES256
            - Value: AES256-GCM-16
          Phase1IntegrityAlgorithms:
            - Value: SHA2-256
            - Value: SHA2-384
          Phase2IntegrityAlgorithms:
            - Value: SHA2-256
            - Value: SHA2-384
          Phase1DHGroupNumbers:
            - Value: 14
            - Value: 16
          Phase2DHGroupNumbers:
            - Value: 14
            - Value: 16
          StartupAction: start
          PreSharedKey: !If
            - UseProvidedPSK
            - !Ref Tunnel2Psk
            - !Ref 'AWS::NoValue'
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-tgw-vpn'

  # Route in AWS VPC towards on-prem via TGW (for private subnets)
  RouteToOnPrem:
    Type: AWS::EC2::Route
    DependsOn:
      - VpcAttach
    Properties:
      RouteTableId: !Ref RtPrivate
      DestinationCidrBlock: !Ref OnPremCidr
      TransitGatewayId: !Ref TGW

Outputs:
  SimulatedOnPremEnabled:
    Value: !Ref SimulateOnPrem

  OnPremRouterEipAllocationId:
    Condition: DoSimOnPrem
    Description: AllocationId for the simulated on-prem EIP
    Value: !Ref OnPremRouterEip

  OnPremRouterEipAddress:
    Condition: DoSimOnPrem
    Description: Public IP used by the Customer Gateway & pfSense UI
    Value: !GetAtt OnPremRouterEip.PublicIp

  OnPremRouterUiUrl:
    Condition: DoSimOnPrem
    Value: !Sub 'https://${OnPremRouterEip.PublicIp}'
    Description: pfSense Web UI (allowed by AdminCidr)

  OnPremServerPrivateIp:
    Condition: DoSimOnPrem
    Value: !GetAtt OnPremServer.PrivateIp

  AwsTestInstancePrivateIp:
    Value: !GetAtt AwsTestInstance.PrivateIp

  VpnConnectionId:
    Value: !Ref VpnConnection

  CustomerGatewayId:
    Value: !Ref CustomerGateway

  TransitGatewayId:
    Value: !Ref TGW
